\chapter{Localizing Categorical Models}

In this chapter we finally talk about localizing contextual categories. To do
this, we first specify a class of maps we localize at, explaining the rationale
behind our choice, and then from this we construct a fibrational structure which
will allow us to apply the results from the previous section. We also briefly
mention the \emph{Internal Languages Conjecture}.

\section{Bi-Invertibility}

As anticipated, we introduce a notion of weak equivalence in our context.

\begin{defn}
  Given a categorical model of type theory $\sfC$, a morphism
  $f\colon\Gamma.A\rightarrow\Gamma.B$ over $\Gamma$ is \emph{simply
    bi-invertible over $\Gamma$} if there exist:
  \begin{enumerate}
    \item a morphism $g_1\colon\Gamma.B\rightarrow\Gamma.A$;
    \item a section
      $\eta\colon\Gamma\rightarrow\Gamma.(1_{\Gamma.A},g_1f)^*\Ids_{A}$;
    \item a morphism $g_2\colon\Gamma.B\rightarrow\Gamma.A$;
    \item a section
      $\epsilon\colon\Gamma\rightarrow\Gamma.(1_{\Gamma.A},fg_2)^*\Ids_{A}$.
  \end{enumerate}
\end{defn}

We now generalize the above definition to arbitrary context extensions by
working as usual with $\sfC^{cxt}$ to provide the notion given in
\cite[Def.~1.4]{Kap17}.

\begin{defn}
  Given a categorical model of type theory $\sfC$, a morphism
  $f\colon\Gamma.\Delta\rightarrow\Gamma.\Theta$ over $\Gamma$ is
  \emph{bi-invertible over $\Gamma$} if it is simply bi-invertible over $\Gamma$
  as a morphism between the two corresponding simple context extensions of
  $\Gamma$ in $\sfC^{cxt}$. It
  is then called \emph{bi-invertible} if $\Gamma$ is the terminal
  context.
\end{defn}

\begin{rmk}
  Our interest in simply bi-invertible morphisms stems from the fact that they
  model the right notion of invertible map in dependent type theory: indeed,
  from the
  required data for a simply bi-invertible map $f$ over $\Gamma$ we can provide
  a section $\Gamma\rightarrow\Gamma.\ishiso{f}$ \wfd{(MAYBE ACTUALLY DO IT?)},
  which is the externalization of the definition of $\ishiso{f}$ of
  \cite[Def.~B.3.3]{KL12}, which itself is the translation into the language of
  contextual categories of the notion of bi-invertible map in type theory
  \cite[Def~4.3.1]{Uni13}.

  It is important to note that, while type theory has no way to encode
  internally the concept of isomorphism of the contextual model, it does have
  its own internal notion of isomorphism. However, given a map $f$, the type
  $\isiso{f}$ is not, in general, a \emph{mere proposition}
  \cite[Def.~3.3.1]{Uni13}, unlike $\ishiso{f}$
  \cite[Thm.~4.3.2]{Uni13}, which makes the latter
  preferable. Also, every bi-invertible map can be given the structure of an
  isomorphism and viceversa, hence they are closely related.
\end{rmk}

\begin{rmk}
Localizing a contextual category with an $\Ids$-structure at bi-invertible maps
gives us an $\infty$-category modeling a dependent type theory with intensional
identity types REFS. It has been conjectured that such a type theory should
provide the internal language of $\infty$-categories, but a precise statement of
this correspondence has not yet been produced and only a few results in this
direction have
been proven so far. A conjecture of this kind would amount to an equivalence
between
an $\infty$-category of contextual categories with some extra structures and an
$\infty$-category of structured $\infty$-categories induced by the localization
at bi-invertible maps, which means that first have to determine what we
properties the localization has.
\end{rmk}

To study the localizations of categorical models of type theory we want to apply
the results from the previous section, which require us to specify a
fibrational structure by providing a class
of fibrations.

\begin{defn}[\cite{Bro73}]
  A \emph{fibration category} is a triple $(\cP,W,\fib)$ where $\cP$ is a
  category and $W$, $\fib$ are wide subcategories such that:
  \begin{enumerate}
    \item $\cP$ has a terminal object;
    \item maps to the terminal object lie in $\fib$;
    \item $\fib$ and $W\cap \fib$ are closed under pullback along any map in $\cP$;
    \item every map in $\cP$ can be factored as a map in $W$ followed by one in
      $\fib$;
    \item $W$ has the 2-out-of-6 property.
  \end{enumerate}
\end{defn}

\begin{rmk}
  Seeing $\cP$, $W$ and $\fib$ in the above definition as $\infty$-categories, we
  notice that the triple has canonically the structure of an $\infty$-category
  of fibrant objects, hence we shall adopt the conventions we used in that
  context.
\end{rmk}

\begin{rmk}[\cite{AKL15}]
  Our definition differs slightly from the original one by Brown
  because it asks for $W$ to be closed under the 2-out-of-6 property
  instead of the more classical 2-out-of-3, but, as shown by Cisinski, if all of
  the other axioms are satisfied the following are equivalent:
  \begin{enumerate}
    \item $W$ has the 2-out-of-6 property;
    \item $W$ has the 2-out-of-3 and is saturated, that is a morphism in $\cP$
      becomes invertible in $\ho(\cP)$ if and only if it lies in $W$.
  \end{enumerate}
  See \cite[Thm.~7.2.7]{RB06}.
\end{rmk}

Now we have enough to specify the fibrational structure.

\begin{prop}[\cite{AKL15}]
  A categorical model of type theory $\sfC$ which also has a $\Nat$ and a
  $\mathsf{1}$
  structure carries the structure of a fibration category, where maps isomorphic
  to dependent projections are the fibrations and bi-invertible ones are the
  weak equivalences.
\end{prop}

The above result can be however generalized.

\begin{prop}\label{fibcat}
  A contextual category with $\Sigmas$ and $\Ids$ structures $\sfC$ carries the
  structure of a fibration category given by the same classes of maps as above.
\end{prop}
\begin{proof}
  It suffices to note that at no point the proof by Lumsdaine uses the other
  structures.
\end{proof}

\section{Cartesian Closure}

We are now ready to provide a few results needed to show that the hypothesis of
Theorem \ref{7616} are satisfied by a categorical
model of type theory with respect to the above fibrational structure.

\begin{lem}[\cite{Kap17}]\label{radj}
  For any dependent projection $p_\Delta\colon\Gamma.\Delta\rightarrow\Gamma$ in
  a categorical model of type theory $\sfC$, the pullback functor
  $p_\Delta^*\colon\sfC(\Gamma)\rightarrow\sfC(\Gamma.\Delta)$ between the fibrant
  slices admits a right adjoint.
\end{lem}
\begin{proof}
  \wfd{(HERE I WOULD LIKE TO USE INTERNAL REASONING TO THINK ABOUT HOW THE MAPS
  BEHAVE, AS IN AKL15, 3.2.10 or 3.2.12)}

  Let's set $(p_\Delta)_*(\Gamma.\Delta.\Theta)=\Gamma.\Pis(\Delta.\Theta)$. Our
  counit shall be given by
  \[\epsilon_{\Gamma.\Delta.\Theta}\colon\Gamma.\Delta.p^*_\Delta\Pis(\Delta,\Theta)
  \xrightarrow{\exch_{\Delta,\Pis(\Delta,\Theta)}}\Gamma.\Pis(\Delta,\Theta).p^*_{\Pis(\Delta,\Theta)}\Delta
  \xrightarrow{\app_{\Delta,\Theta}}\Gamma.\Delta.\Theta\]
  and it is then sufficient to prove that, for any context morphism
  $f\colon\Gamma.\Delta.p^*_\Delta\Psi\rightarrow\Gamma.\Delta.\Theta$ over
  $\Gamma.\Delta$, there is
  a unique $\tilde{f}\colon\Gamma.\Psi\rightarrow\Gamma.\Pis(\Delta,\Theta)$
  making the diagram
  \[\begin{tikzcd}
    {\Gamma.\Delta.p^*_\Delta\Psi} \\
    {\Gamma.\Delta.p^*_\Delta\Pis(\Delta,\Theta)} & {\Gamma.\Delta.\Theta}
    \arrow["f", from=1-1, to=2-2]
    \arrow["{\epsilon_{\Gamma.\Delta.\Theta}}"', from=2-1, to=2-2]
    \arrow["{p^*_\Delta(\tilde{f})}"', dotted, from=1-1, to=2-1]
  \end{tikzcd}\]
  commute. This will then uniquely specify how the right adjoint acts on the
  morphisms.

  We start by specifying the unit
  $\eta_{\Gamma.\Psi}\colon\Gamma.\Psi\rightarrow\Gamma.\Pis(\Delta,p^*_{\Delta}\Psi)$.

  Let's consider the commutative square
  \[\begin{tikzcd}[column sep=huge]
    {\Gamma.\Psi.p^*_\Psi\Pis(\Delta,p^*_\Delta\Psi)} & {\Gamma.\Pis(\Delta,p^*_\Delta\Psi)} \\
    {\Gamma.\Psi} & \Gamma
    \arrow["{p_{\Pis(\Delta,p^*_\Delta\Psi)}}"', from=1-1, to=2-1]
    \arrow["{p_{\Psi}}"', from=2-1, to=2-2]
    \arrow["{p_{\Pis(\Delta,p^*_\Delta\Psi)}}", from=1-2, to=2-2]
    \arrow["{q(p_\Psi,\Pis(\Delta,p^*_\Delta\Psi))}", from=1-1, to=1-2]
  \end{tikzcd}\]
  where the map $q(p_\Psi,\Pis(\Delta,p^*_\Delta\Psi))$ acts as $(x,f)\mapsto
  f$. If we can provide a section of the left map
  corresponding to $x\mapsto(x,\lambda(y:\Delta).x)$ we are
  done as we can then compose
  it with $q(p_\Psi,\Pis(\Delta,p^*_\Delta\Psi))$ to get our unit.
  
  To construct it first we look at the commutative square
  \[\begin{tikzcd}
    {\Gamma.\Psi} \\
    & {\Gamma.\Psi.p^*_\Psi\Psi} & {\Gamma.\Psi} \\
    & {\Gamma.\Psi} & \Gamma
    \arrow["{p_\Psi}", from=2-3, to=3-3]
    \arrow["{p_\Psi}"', from=3-2, to=3-3]
    \arrow["{p_{p^*_\Psi\Psi}}", from=2-2, to=3-2]
    \arrow["{q(p_\Psi,\Psi)}"', from=2-2, to=2-3]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow[curve={height=-12pt}, Rightarrow, no head, from=1-1, to=2-3]
    \arrow["{(1_\Psi,1_\Psi)}"{description}, dotted, from=1-1, to=2-2]
  \end{tikzcd},\]
  where the factorization corresponds to $x\mapsto(x,x)$. Then, we pull back
  along $p_{p^*_\Psi\Delta}$, getting a section
  $p^*_{p^*_\Psi\Delta}(1_\Psi,1_\Psi)\colon\Gamma.\Psi.p^*_\Psi\Delta\rightarrow\Gamma.\Psi.p^*_\Psi\Delta.p^*_{p^*_\Psi\Delta}\Psi$.

  We then apply $\lambda$, which gives us a section
  \[\lambda(p^*_{p^*_\Psi\Delta}(1_\Psi,1_\Psi))=\lambda(1_{p^*_\Psi\Delta},p_{p^*_\Psi\Delta})
\colon\Gamma.\Psi\rightarrow\Gamma.\Psi.p^*_\Psi\Pis(\Delta,p^*_\Delta\Psi),\]
which is exactly what we were looking for. We can then conclude the construction
of the unit by post-composing with
  $q(p_\Psi,\Pis(\Delta,p^*_\Delta\Psi))\colon\Gamma.\Psi.p^*_\Psi\Pis(\Delta,p^*_\Delta\Psi)\rightarrow\Gamma.\Pis(\Delta,p^*_\Delta\Psi)$,
  as anticipated.

  We then define our lift $\tilde{f}$ as the composite
  $\Gamma.\Pis(\Delta,f)\cdot\eta_{\Gamma.\Psi}$. The commutativity of the above
  triangle follows by $\beta$-reduction \wfd{(WE DO NOT HAVE IT!!!)}, while the
  uniqueness of the $\tilde{f}$
  giving the desired factorization by the $\Pies$-property. \wfd{(PLEASE
  PROVE IT)}

  This also shows that $(p_{\Delta})_*(f)=\Gamma.\Pis(\Delta,f)$, meaning that
  the construction of $\Gamma.\Pis(\Delta,f)$ is functorial.
\end{proof}

We know that every fibration in $\sfC$ is isomorphic to a dependent
projection, so this tells us that every fibration induces an adjunction
between fibrant slices.

We are finally ready to prove the last result leading to the final one we want.

\begin{lem}[\cite{Kap17}]\label{lccfc}
  In the above conditions, the functor
  $(p_\Delta)_*\colon\sfC(\Gamma.\Delta)\rightarrow\sfC(\Gamma)$ is left exact.
\end{lem}
\begin{proof}
  As a right adjoint, $(p_\Delta)_*$ preserves limits and in particular
  pullbacks and the terminal object. Also, by Lemma \ref{piequal}, it preserves
  dependent projections. Finally, Shulman noted in \cite[21]{Shu14} that a
  categorical model of type theory is a \emph{split type-theoretic fibration
  category} \cite[Def.~4.1]{Shu14}, thus function extensionality and
  \cite[Thm.~5.9]{Shu14} imply that our functor also preserves trivial
  fibrations and therefore, by Corollary \ref{7414}, weak equivalences.
\end{proof}

Again, the above extends to all fibrations in $\sfC$.

\begin{thm}[\cite{Kap17}]
  Given a categorical model of type theory $\sfC$, the $\infty$-category $L(\sfC)$
  is locally cartesian closed.
\end{thm}
\begin{proof}
  We already know that it is finitely complete by \ref{7518}. The hypothesis of
  Theorem \ref{7616} are satisfied by Lemma \ref{radj} and Lemma \ref{lccfc}.
\end{proof}

\begin{thm}
  A contextual functor between categorical models of type theory is sent by the
  localization functor $\Hoi$ to a left exact functor.
\end{thm}
\begin{proof}
  By definition, such a functor preserves fibrations, chosen pullbacks, terminal
  object and $\Ids$-structure, thus it is left exact. We can then apply
  Proposition \ref{7528}.
\end{proof}
